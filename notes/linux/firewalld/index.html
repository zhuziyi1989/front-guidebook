<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/umi.331878c1.css" />
    <script>
      window.routerBase = "/";
    </script>
    <script>
      //! umi version: 3.5.20
    </script>
    <script>
      !(function () {
        var e = localStorage.getItem("dumi:prefers-color"),
          t = window.matchMedia("(prefers-color-scheme: dark)").matches,
          r = ["light", "dark", "auto"];
        document.documentElement.setAttribute(
          "data-prefers-color",
          e === r[2] ? (t ? r[1] : r[0]) : r.indexOf(e) > -1 ? e : r[0]
        );
      })();
    </script>
    <title>CentOS 8防火墙配置、管理与实践 - 前端指南</title>
  </head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-route="/notes/linux/firewalld" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;./favicon.png&#x27;)" href="/">前端指南</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><span><a aria-current="page" class="active" href="/notes">笔记</a></span><span><a href="/interview">关于面试</a></span><span><a href="/words">单词</a></span><span><a target="_blank" rel="noopener noreferrer" href="https://github.com/zhuziyi1989/front-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></span><div class="__dumi-default-navbar-tool"><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "></div></div></div></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;./favicon.png&#x27;)" href="/"></a><h1>前端指南</h1><p>一份前端知识体系指南 &amp; 私人技术笔记 🎉</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a aria-current="page" class="active" href="/notes">笔记</a></li><li><a href="/interview">关于面试</a></li><li><a href="/words">单词</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/zhuziyi1989/front-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul><div class="__dumi-default-dark"><div class="__dumi-default-dark-switch "><button title="Dark theme" class="__dumi-default-dark-moon "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3854" width="22" height="22"><path d="M991.816611 674.909091a69.166545 69.166545 0 0 0-51.665455-23.272727 70.795636 70.795636 0 0 0-27.438545 5.585454A415.674182 415.674182 0 0 1 754.993338 698.181818c-209.594182 0-393.472-184.785455-393.472-395.636363 0-52.363636 38.539636-119.621818 69.515637-173.614546 4.887273-8.610909 9.634909-16.756364 14.103272-24.901818A69.818182 69.818182 0 0 0 384.631156 0a70.842182 70.842182 0 0 0-27.438545 5.585455C161.678429 90.298182 14.362065 307.898182 14.362065 512c0 282.298182 238.824727 512 532.38691 512a522.286545 522.286545 0 0 0 453.957818-268.334545A69.818182 69.818182 0 0 0 991.816611 674.909091zM546.679156 954.181818c-248.785455 0-462.941091-192-462.941091-442.181818 0-186.647273 140.637091-372.829091 300.939637-442.181818-36.817455 65.629091-92.578909 151.970909-92.578909 232.727273 0 250.181818 214.109091 465.454545 462.917818 465.454545a488.331636 488.331636 0 0 0 185.181091-46.545455 453.003636 453.003636 0 0 1-393.565091 232.727273z m103.656728-669.323636l-14.266182 83.781818a34.909091 34.909091 0 0 0 50.362182 36.770909l74.775272-39.563636 74.752 39.563636a36.142545 36.142545 0 0 0 16.174546 3.956364 34.909091 34.909091 0 0 0 34.210909-40.727273l-14.289455-83.781818 60.509091-59.345455a35.025455 35.025455 0 0 0-19.223272-59.578182l-83.61891-12.101818-37.376-76.101818a34.56 34.56 0 0 0-62.254545 0l-37.376 76.101818-83.618909 12.101818a34.909091 34.909091 0 0 0-19.246546 59.578182z m70.423272-64.698182a34.280727 34.280727 0 0 0 26.135273-19.083636l14.312727-29.090909 14.336 29.090909a34.257455 34.257455 0 0 0 26.135273 19.083636l32.046546 4.887273-23.272728 22.574545a35.234909 35.234909 0 0 0-10.007272 30.952727l5.46909 32.116364-28.625454-15.127273a34.490182 34.490182 0 0 0-32.302546 0l-28.695272 15.127273 5.469091-32.116364a35.141818 35.141818 0 0 0-9.984-30.952727l-23.272728-22.574545z" p-id="3855"></path></svg></button><button title="Light theme" class="__dumi-default-dark-sun "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4026" width="22" height="22"><path d="M915.2 476.16h-43.968c-24.704 0-44.736 16-44.736 35.84s20.032 35.904 44.736 35.904H915.2c24.768 0 44.8-16.064 44.8-35.904s-20.032-35.84-44.8-35.84zM512 265.6c-136.704 0-246.464 109.824-246.464 246.4 0 136.704 109.76 246.464 246.464 246.464S758.4 648.704 758.4 512c0-136.576-109.696-246.4-246.4-246.4z m0 425.6c-99.008 0-179.2-80.128-179.2-179.2 0-98.944 80.192-179.2 179.2-179.2S691.2 413.056 691.2 512c0 99.072-80.192 179.2-179.2 179.2zM197.44 512c0-19.84-19.136-35.84-43.904-35.84H108.8c-24.768 0-44.8 16-44.8 35.84s20.032 35.904 44.8 35.904h44.736c24.768 0 43.904-16.064 43.904-35.904zM512 198.464c19.776 0 35.84-20.032 35.84-44.8v-44.8C547.84 84.032 531.84 64 512 64s-35.904 20.032-35.904 44.8v44.8c0 24.768 16.128 44.864 35.904 44.864z m0 627.136c-19.776 0-35.904 20.032-35.904 44.8v44.736C476.096 940.032 492.16 960 512 960s35.84-20.032 35.84-44.8v-44.736c0-24.768-16.064-44.864-35.84-44.864z m329.92-592.832c17.472-17.536 20.288-43.072 6.4-57.024-14.016-14.016-39.488-11.2-57.024 6.336-4.736 4.864-26.496 26.496-31.36 31.36-17.472 17.472-20.288 43.008-6.336 57.024 13.952 14.016 39.488 11.2 57.024-6.336 4.8-4.864 26.496-26.56 31.296-31.36zM213.376 759.936c-4.864 4.8-26.56 26.624-31.36 31.36-17.472 17.472-20.288 42.944-6.4 56.96 14.016 13.952 39.552 11.2 57.024-6.336 4.8-4.736 26.56-26.496 31.36-31.36 17.472-17.472 20.288-43.008 6.336-56.96-14.016-13.952-39.552-11.072-56.96 6.336z m19.328-577.92c-17.536-17.536-43.008-20.352-57.024-6.336-14.08 14.016-11.136 39.488 6.336 57.024 4.864 4.864 26.496 26.56 31.36 31.424 17.536 17.408 43.008 20.288 56.96 6.336 14.016-14.016 11.264-39.488-6.336-57.024-4.736-4.864-26.496-26.56-31.296-31.424z m527.168 628.608c4.864 4.864 26.624 26.624 31.36 31.424 17.536 17.408 43.072 20.224 57.088 6.336 13.952-14.016 11.072-39.552-6.4-57.024-4.864-4.8-26.56-26.496-31.36-31.36-17.472-17.408-43.072-20.288-57.024-6.336-13.952 14.016-11.008 39.488 6.336 56.96z" p-id="4027"></path></svg></button><button title="Default to system" class="__dumi-default-dark-auto "><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="11002" width="22" height="22"><path d="M127.658667 492.885333c0-51.882667 10.24-101.717333 30.378666-149.162666s47.786667-88.064 81.92-122.538667 75.093333-61.781333 122.538667-81.92 96.938667-30.378667 149.162667-30.378667 101.717333 10.24 149.162666 30.378667 88.405333 47.786667 122.88 81.92 61.781333 75.093333 81.92 122.538667 30.378667 96.938667 30.378667 149.162666-10.24 101.717333-30.378667 149.162667-47.786667 88.405333-81.92 122.88-75.093333 61.781333-122.88 81.92-97.28 30.378667-149.162666 30.378667-101.717333-10.24-149.162667-30.378667-88.064-47.786667-122.538667-81.92-61.781333-75.093333-81.92-122.88-30.378667-96.938667-30.378666-149.162667z m329.045333 0c0 130.048 13.994667 244.394667 41.984 343.381334h12.970667c46.762667 0 91.136-9.216 133.461333-27.306667s78.848-42.666667 109.568-73.386667 54.954667-67.242667 73.386667-109.568 27.306667-86.698667 27.306666-133.461333c0-46.421333-9.216-90.794667-27.306666-133.12s-42.666667-78.848-73.386667-109.568-67.242667-54.954667-109.568-73.386667-86.698667-27.306667-133.461333-27.306666h-11.605334c-28.672 123.562667-43.349333 237.909333-43.349333 343.722666z" p-id="11003"></path></svg></button></div></div></div><ul class="__dumi-default-menu-list"><li><a target="_blank" rel="noopener noreferrer">玩转 Linux 系统</a><ul><li><a aria-current="page" class="active" href="/notes/linux/firewalld"><span>CentOS 8防火墙配置、管理与实践</span></a></li><li><a href="/notes/linux/issue"><span>Linux 远程登录欢迎语</span></a></li></ul></li><li><a href="/notes">笔记</a></li><li><a href="/notes/array&amp;object">数组和对象的方法</a></li><li><a href="/notes/array.prototype">Array.prototype.map()</a></li><li><a href="/notes/git">Git 相关笔记</a></li><li><a href="/notes/linux">玩转 Linux 系统</a><ul><li><a href="/notes/linux/vim"><span>VIM 速查手册</span></a></li></ul></li><li><a href="/notes/npm">NPM 相关笔记</a></li><li><a href="/notes/vscode">文本编辑器的使用</a></li><li><a href="/notes/vue">Vue</a><ul><li><a href="/notes/vue"><span>问题列表</span></a></li><li><a href="/notes/vue/组件通信"><span>Vue中8种组件通信方式</span></a></li></ul></li><li><a href="/notes/webpack">Webpack 相关笔记</a></li><li><a href="/notes/work">关于换工作的一些总结</a></li></ul></div></div><ul role="slug-list" class="__dumi-default-layout-toc"><li title="防火墙firewalld" data-depth="2"><a href="/notes/linux/firewalld#防火墙firewalld"><span>防火墙firewalld</span></a></li><li title="认识firewalld" data-depth="2"><a href="/notes/linux/firewalld#认识firewalld"><span>认识firewalld</span></a></li><li title="区域(zone)" data-depth="3"><a href="/notes/linux/firewalld#区域zone"><span>区域(zone)</span></a></li><li title="服务(service)" data-depth="3"><a href="/notes/linux/firewalld#服务service"><span>服务(service)</span></a></li><li title="运行时和永久设置" data-depth="3"><a href="/notes/linux/firewalld#运行时和永久设置"><span>运行时和永久设置</span></a></li><li title="区域里包含的基本信息" data-depth="3"><a href="/notes/linux/firewalld#区域里包含的基本信息"><span>区域里包含的基本信息</span></a></li><li title="匹配的优先级（包处理流程）" data-depth="3"><a href="/notes/linux/firewalld#匹配的优先级包处理流程"><span>匹配的优先级（包处理流程）</span></a></li><li title="在firewalld上的操作" data-depth="2"><a href="/notes/linux/firewalld#在firewalld上的操作"><span>在firewalld上的操作</span></a></li><li title="默认的zone" data-depth="3"><a href="/notes/linux/firewalld#默认的zone"><span>默认的zone</span></a></li><li title="常用命令" data-depth="3"><a href="/notes/linux/firewalld#常用命令"><span>常用命令</span></a></li><li title="实践" data-depth="2"><a href="/notes/linux/firewalld#实践"><span>实践</span></a></li><li title="1. 放行整个区域" data-depth="3"><a href="/notes/linux/firewalld#1-放行整个区域"><span>1. 放行整个区域</span></a></li><li title="2. 放行源地址" data-depth="3"><a href="/notes/linux/firewalld#2-放行源地址"><span>2. 放行源地址</span></a></li><li title="3. docker容器内dns问题" data-depth="3"><a href="/notes/linux/firewalld#3-docker容器内dns问题"><span>3. docker容器内dns问题</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="centos-8防火墙配置管理与实践"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#centos-8防火墙配置管理与实践"><span class="icon icon-link"></span></a>CentOS 8防火墙配置、管理与实践</h1><p><em>在本文中，将展示如何为您的CentOS 8设置防火墙，并在<code>firewall-cmd</code>管理工具的帮助下进行管理。</em></p><h2 id="防火墙firewalld"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#防火墙firewalld"><span class="icon icon-link"></span></a>防火墙<code>firewalld</code></h2><p><strong>防火墙</strong>是被用于从不信任的流量中保护工作站或者服务器的机制，它通过定义一组安全规则来工作，这些安全规则确定是允许还是阻止特定流量，正确配置的防火墙是整个系统安全的最重要方面之一，<strong>CentOS 8提供了一个动态的、可定制的、基于主机的、带有D-Bus接口的防火墙——<code>firewalld</code></strong>。在CentOS 8中，<code>nftables</code>取代<code>iptables</code>成为默认的Linux网络包过滤框架，中间采取daemon动态管理防火墙，管理工具是<code>firewalld</code>。也就是说，<code>firewalld</code>只是一个前端管理工具，它负责配置规则，真正起作用的是后面的过滤框架。</p><p><a target="_blank" rel="noopener noreferrer" href="https://i.loli.net/2020/03/10/6Si5vcJ7Anpqwjg.png"><img src="https://i.loli.net/2020/03/10/6Si5vcJ7Anpqwjg.png" alt="img"/></a></p><p><code>firewalld</code>其实在CentOS 7中就已经存在，可能大多数人更习惯于<code>iptables</code>。<code>iptables</code>里默认是每个服务是允许，需要拒绝的才去限制。而与<code>iptables</code>相反，<strong><code>firewalld</code>默认是拒绝</strong>，需要放行的服务需要去设置。<code>firewalld</code>和<code>iptables</code>还有很多区别，这里不展开说来，有兴趣的同学请戳☞<a target="_blank" rel="noopener noreferrer" href="https://firewalld.org/">firewalld官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>或者自行去了解。</p><p>要配置防火墙，<strong>你必须以root或者具有<code>sudo</code>权限的用户的身份登录</strong>。<code>firewalld</code>可以通过<code>firewall-cmd</code>命令行工具和图形化工具<code>firewll-config</code>等来配置和管理，本文均采用命令行的方式叙述。</p><p>首先确定<code>firewalld</code>是运行着：</p><div class="__dumi-default-code-block"><pre class="prism-code language-shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --state </span><span class="token comment"># firewalld的状态，启动为`running`，未启动为`not running`</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain"></span><span class="token comment"># 如果发现firewall基于某些原因没有安装或者启动:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">yum </span><span class="token function">install</span><span class="token plain"> firewalld firewall-config </span><span class="token comment"># 安装firewalld，其中firewall-config是图形界面，可以选择不安装</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">systemctl start  firewalld </span><span class="token comment"># 启动</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">systemctl stop firewalld  </span><span class="token comment"># 停止</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">systemctl </span><span class="token builtin class-name">enable</span><span class="token plain"> firewalld </span><span class="token comment"># 启用自动启动</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">systemctl disable firewalld </span><span class="token comment"># 禁用自动启动</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">systemctl status firewalld </span><span class="token comment"># 或者 firewall-cmd --state 查看状态</span></div></pre></div><p>接下来介绍<code>firewalld</code>的基本概念和操作。</p><hr/><h2 id="认识firewalld"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#认识firewalld"><span class="icon icon-link"></span></a>认识<code>firewalld</code></h2><p><code>firewalld</code>使用<strong>区域</strong>和<strong>服务</strong>的概念。基于区域和服务，能够允许或阻止进入或流出系统的网络流量。</p><h3 id="区域zone"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#区域zone"><span class="icon icon-link"></span></a>区域(zone)</h3><p>区域是预定义的规则集，指定您的计算机所连接的网络的信任级别。<strong>可以将网卡接口(Interfaces)和源地址(Sources)分配到区域，这也是激活区域的方法。</strong></p><p>可以通过以下命令来查看所有的区域：</p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --get-zones</span></div><div class="token-line"><span class="token plain">#或者</span></div><div class="token-line"><span class="token plain">$ ls -l /usr/lib/firewalld/zones/</span></div></pre></div><p>下面是<code>firewalld</code>提供的区域，它们根据区域的信任级别从不可信到可信排序：</p><table><thead><tr><th>区域</th><th>描述</th></tr></thead><tbody><tr><td><strong>drop</strong></td><td>任何传入的网络连接都被丢弃，并且没有任何通知（发送方无法感知）。仅能有发送出去的网络连接。</td></tr><tr><td><strong>block</strong></td><td>任何接收的网络连接都被 IPv4 的 <code>icmp-host-prohibited</code> 信息和 IPv6 的 <code>icmp6-adm-prohibited</code> 信息所拒绝（发送方可感知），即拒绝所有网络连接，但是您可以允许选定的传入连接。</td></tr><tr><td><strong>public</strong></td><td>供不受信任的公众地方使用。仅接受ssh或dhcpv6-client等服务连接（仅仅接收经过选择的连接）。<strong>这个也是默认设置的区域</strong>。</td></tr><tr><td><strong>external</strong></td><td>用于在系统充当网关或路由器时并启用了NAT伪装的外部网络，出去的ipv4网络连接通过此区域伪装和转发，仅仅接收经过选择的连接。</td></tr><tr><td><strong>internal</strong></td><td>用于在系统充当网关或路由器时的内部网络。网络上的其他系统通常是受信任的。仅允许选择的传入连接。</td></tr><tr><td><strong>dmz</strong></td><td>经典的非军事区(DMZ)区域，提供对LAN的有限访问，仅接受ssh服务接连（仅仅接收经过选择的连接）。</td></tr><tr><td><strong>work</strong></td><td>用于工作机器。网络上的其他计算机通常是可信的。仅接受ssh、ipp-client或dhcpv6-client服务连接 （仅仅接收经过选择的连接）。</td></tr><tr><td><strong>home</strong></td><td>用于家用机器。网络上的其他计算机通常是可信的。仅接受ssh、mdns、ipp-client、samba-client、或dhcpv6-client服务连接（仅仅接收经过选择的连接）。</td></tr><tr><td><strong>trusted</strong></td><td>接受所有网络连接。信任网络中的所有计算机。</td></tr></tbody></table><p>需要注意的是，block会明确拒绝掉数据包，而drop会选择丢弃掉数据包。因此，drop比较节省服务器资源；block会回应，比较占用资源。区域的规则不是固定的，用户可以根据自身的需求定制。</p><h3 id="服务service"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#服务service"><span class="icon icon-link"></span></a>服务(service)</h3><p>服务只是本地端口、协议、源端口、目的地和防火墙帮助模块的列表，例如：</p><ul><li>Port – 443 or 25 or 110</li><li>Service – SSH, HTTP</li><li>Protocols – ICMP</li></ul><p>除了以上两个基本概念还有一些其他的配置项要注意：</p><h3 id="运行时和永久设置"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#运行时和永久设置"><span class="icon icon-link"></span></a>运行时和永久设置</h3><p><code>firewalld</code>使用两个独立的配置集，即运行时配置和永久配置。</p><p>运行时配置是实际运行的配置，在重新启动后不再生效。当<code>firewalld</code>守护进程启动时，它将加载永久配置，该配置将成为运行时配置。</p><p>在<code>firewalld-cmd</code>执行的命令中，如果是规则相关的，加上<code>--permanent</code>参数不会立即生效，只会被记录到配置文件。如果要生效需要调用<code>firewall-cmd --reload</code>重新加载；如果不加<code>--permanent</code>则是立即生效，但如果重新加载会被清掉。</p><p>此外，在<code>firewall-cmd</code>命令中有些命令需要必须加<code>--permanent</code>参数，比如<code>--set-target</code>。</p><p>要在两个配置集中应用更改，您可以使用以下两种方法之一:</p><ol><li>更改运行时配置并使其永久:</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd &lt;options&gt;</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --runtime-to-permanent # 将之前做的更改永久化</span></div></pre></div><ol><li>更改永久配置并重新加载<code>firewalld</code>守护进程:</li></ol><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --permanent &lt;options</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --reload # 永久配置重启生效</span></div></pre></div><h3 id="区域里包含的基本信息"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#区域里包含的基本信息"><span class="icon icon-link"></span></a>区域里包含的基本信息</h3><p>当查询某区域的信息时：</p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --zone=work --list-all</span></div></pre></div><p>输出信息：</p><p><a target="_blank" rel="noopener noreferrer" href="https://i.loli.net/2020/03/09/zvYksrayhmc1Q56.png"><img src="https://i.loli.net/2020/03/09/zvYksrayhmc1Q56.png" alt="img"/></a></p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">target:default</span></div></pre></div><p>区域放行策略。它决定了与该区域匹配，但是没有由这里的设置中显式处理的数据包的动作，可结合</p><p>匹配的优先级</p><p>来理解。它有四个值：</p><ul><li><p><code>ACCEPT</code>：通过这个包。</p></li><li><p><code>%%REJECT%%</code>：拒绝这个包，并返回一个拒绝的回复。</p></li><li><p><code>DROP</code>：丢弃这个包，不回复任何信息。</p></li><li><p><code>default</code>：不做任何事情。该区域不再管它，把它踢到“楼上”。</p></li><li><p><code>icmp-block-inversion</code> 这个是一个禁ping的参数，默认关闭</p></li><li><p><code>work (active)</code> active表示该区域是活动的，因为，它至少有一个接口或源分配给它。再次注意，<strong>将网卡接口和源分配到区域上将激活区域。</strong></p></li><li><p><code>interfaces: docker0</code> （网卡接口）是系统中的硬件和虚拟的网络适配器的名字，所有的活动的接口都将被分配到区域，要么是默认的区域，要么是用户指定的一个区域。但是，<strong>一个接口不能被分配给多于一个的区域</strong>。</p></li><li><p><code>sources:</code> 列出了分配到这个区域的源，可以是ip地址也可以是ip地址段。<strong>一个源（或重叠的源）不能被分配到多个区域</strong>。这样做的结果是产生一个未定义的行为，因为不清楚应该将哪些规则应用于该源。</p></li><li><p><code>services: dockpit dhcpv6-client ssh</code> 列出了允许通过这个防火墙的服务。你可以通过运行 <code>firewall-cmd --get-services</code> 得到一个防火墙预定义服务的详细列表。</p></li><li><p><code>ports:</code> 列出了一个允许通过这个防火墙的目标端口。它是用于你需要去允许一个没有在 <code>firewalld</code> 中定义的服务的情况下。</p></li><li><p><code>protocal</code>当前 Zone 开启的协议。通过 <code>/etc/protocols</code> 可以查看，常用的协议包括 <code>tcp</code>, <code>udp</code>等。</p></li><li><p><code>masquerade: no</code> 表示这个区域是否允许 IP 伪装。如果允许，它将允许 IP 转发，它可以让你的计算机作为一个路由器。</p></li><li><p><code>forward-ports:</code> 列出转发的端口。</p></li><li><p><code>icmp-blocks:</code> 可添加ICMP类型，当<code>icmp-block-inversion</code>为no时，这些ICMP类型被拒绝；当<code>icmp-block-inversion</code>为yes时，这些ICMP类型被允许。</p></li><li><p><code>rich rules:</code> 富规则，即更细致、更详细的防火墙规则策略，它的优先级在所有的防火墙策略中也是最高的。</p></li></ul><h3 id="匹配的优先级包处理流程"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#匹配的优先级包处理流程"><span class="icon icon-link"></span></a>匹配的优先级（包处理流程）</h3><p>因为指定一个源不是必需的，任何包都可以通过接口匹配而归属于一个区域，而不需要通过源匹配来归属一个区域。活动区域中扮演两个不同的角色。关联接口行为的区域作为接口区域，并且，关联源行为的区域作为源区域（一个区域能够扮演两个角色）。<code>firewalld</code> 按下列顺序处理一个包：</p><ol><li>如果匹配到 source 的 Zone（可以存在零个或一个这样的区域）。如果这个包满足一个<strong>富规则rich rule、服务是白名单中的、target 不是 default</strong>，那么源区域处理这个包，并且在这里结束。否则，向上传递这个包。</li><li>如果匹配到 interface 的 Zone（肯定有一个这样的区域）。如果该Zone能处理这个包，那么到这里结束。否则，向上传递这个包。</li><li>若网络接口未关联到特定的区域，则使用默认区域并执行该区域所指定的规则。</li></ol><p>这里的关键信息是，源区域优先于接口区域。因此，一般多区域的设计模式是：先创建一个 source Zone 允许特殊 IP 地址访问系统服务，再通过 interface Zone 来对其他的访问做限制。</p><p>包处理流程的例子：</p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --zone=home --add-source=192.168.1.1/24</span></div></pre></div><p>当IP为 <code>192.168.1.2</code> 的数据包访问 <code>http</code> 服务时，将会首先匹配到 home Zone，<code>firewall-cmd --zone=home --list-all</code> 查看发现 <code>http</code> 服务没有开启，target 为 default，所以会被丢到上一层；这里假设 <code>192.168.1.1</code> 属于 <code>enp0s8</code> 网卡，那么将会匹配到 drop Zone，target 为 DROP，所以会将包直接丢弃。</p><h2 id="在firewalld上的操作"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#在firewalld上的操作"><span class="icon icon-link"></span></a>在<code>firewalld</code>上的操作</h2><hr/><h3 id="默认的zone"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#默认的zone"><span class="icon icon-link"></span></a>默认的zone</h3><p>所谓默认的zone，就是在你没有使用<code>--zone</code>参数指定zone时，所有操作默认使用的zone，<strong>同时也在包处理流程中的默认zone</strong>。</p><p>获取默认的zone:</p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --get-default-zone # 如果没做过配置，默认的应该为public</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --get-active-zones # 查看活动中的zone</span></div></pre></div><p>当向<code>NetworkManager</code>添加新接口连接(例如eth0或ens3)时，它们被附加到默认的zone。查看网卡接口：</p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ ip link show</span></div><div class="token-line"><span class="token plain"># 或者</span></div><div class="token-line"><span class="token plain">$ nmcli device status</span></div></pre></div><p>改变默认的zone:</p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --set-default-zone=[zone]</span></div></pre></div><h3 id="常用命令"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#常用命令"><span class="icon icon-link"></span></a>常用命令</h3><h4 id="查看具体zone的信息"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#查看具体zone的信息"><span class="icon icon-link"></span></a>查看具体zone的信息</h4><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --zone=[zone] --list-all # 下面是命令输出，对于每一项都可以单独设置</span></div></pre></div><p><strong>活动中的zone</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --get-active-zones # 这个命令会返回所有绑定了source、interface以及默认的zone，并会说明在什么情况下使用。</span></div></pre></div><p><strong>查看所有zone的信息</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --list-all-zones # 查看所有zone的详细信息，这是个很长的列表</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --get-zones # 查看可用的zone</span></div></pre></div><h4 id="设置zone上的规则"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#设置zone上的规则"><span class="icon icon-link"></span></a>设置zone上的规则</h4><h5 id="目标设置target"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#目标设置target"><span class="icon icon-link"></span></a>目标设置(target)</h5><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --permanent --get-target # 这里的 --permanent 不能省略</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --permanent --set-target=[target] # 值有default,ACCEPT,REJECT和DROP，这里的 --permanent 不能省略</span></div></pre></div><h5 id="端口设置ports"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#端口设置ports"><span class="icon icon-link"></span></a>端口设置(ports)</h5><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --zone=[zone] --add-port=8080/tcp # 放行tcp访问的8080端口,协议有tcp/udp/sctp/dccp</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=[zone] --add-port=8080-9090/tcp # 一串端口</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=[zone] --list-ports # 查看端口</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=[zone] --query-port=8080/tcp # 查看指定zone的指定端口</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=[zone] --remove-port=8080/tcp # 移除端口</span></div></pre></div><h5 id="源设置sources"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#源设置sources"><span class="icon icon-link"></span></a>源设置(sources)</h5><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --zone=[zone] --add-source=192.168.1.10/24 # 绑定源到区域</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=[zone] --list-sources # 查看区域所绑定源的列表</span></div><div class="token-line"><span class="token plain">$ firewall-cmd  --zone=[zone] --query-source=192.168.1.10/24 # 查看指定zone是否和指定源绑定</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --get-zone-of-source=192.168.1.10/24 # 通过源查询绑定的区域</span></div><div class="token-line"><span class="token plain">$ firewall-cmd  --zone=[zone] --change-source=192.168.1.10/24 # 用于改变source地址所绑定的zone，如果原来没有绑定则进行绑定</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=[zone] --remove-source=192.168.1.10/24 # 解除源的绑定</span></div></pre></div><h5 id="网卡接口interfaces"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#网卡接口interfaces"><span class="icon icon-link"></span></a>网卡接口(interfaces)</h5><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --zone=[zone] --add-interface=[interface] # 添加指定 interface 到指定的 Zone</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=[zone] --change-interface=[interface] # 将eth1接口分配给work区域</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=[zone] --remove-interface=[interface] # 删除work上的eth1接口</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=[zone] --list-interfaces # 查看指定 Zone 下的 interfaces</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --get-zone-of-interface=[interface] # 通过接口查询绑定的区域</span></div></pre></div><h5 id="端口转发forward-ports"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#端口转发forward-ports"><span class="icon icon-link"></span></a>端口转发(forward-ports)</h5><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --zone=external --add-forward-port=port=80:proto=tcp:toport=8080 # 同一主机上的端口转发</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=external --add-forward-port=port=80:proto=tcp:toaddr=10.10.10.2 # 从80端口转发到10.10.10.2的80端口(默认端口)</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=external --add-forward-port=port=80:proto=tcp:toport=8080:toaddr=10.10.10.2 # 从80端口转发到10.10.10.2的8080端口</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=external --remove-forward-port=port=80:proto=tcp:toport=8080:toaddr=10.10.10.2 # 删除上一条的端口转发</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">### 伪装 ###</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=public --add-masquerade # 如果需要将流量(端口443)转发到lxd服务器/容器托管，请打开伪装</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=public --add-forward-port=port=443:proto=tcp:toport=443:toaddr=192.168.2.42</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=public --remove-masquerade # 删除上面设置的伪装</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=public --remove-forward-port=port=443:proto=tcp:toport=443:toaddr=192.168.2.42</span></div></pre></div><h5 id="服务services"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#服务services"><span class="icon icon-link"></span></a>服务(services)</h5><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --zone=public --add-service=http # 增加服务</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=public --list-services # 列出服务</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=public --remove-service=http # 移除服务</span></div></pre></div><h5 id="协议protocals"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#协议protocals"><span class="icon icon-link"></span></a>协议(protocals)</h5><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --add-protocol=&lt;protocol# 允许协议 (例：icmp，即允许ping)</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --remove-protocol=&lt;protocol# 取消协议</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --list-protocols # 查看允许的协议</span></div></pre></div><h5 id="高级规则rich-rules"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#高级规则rich-rules"><span class="icon icon-link"></span></a>高级规则(rich rules)</h5><div class="__dumi-default-code-block"><pre class="prism-code language-Plaintext"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">//区域里的富规则按先后顺序匹配，按先匹配到的规则生效。#firewall-cmd ↓</span></div><div class="token-line"><span class="token plain">--add-rich-rule=&#x27;&lt;RULE&#x27;    //在指定的区添加一条富规则</span></div><div class="token-line"><span class="token plain">--remove-rich-rule=&#x27;&lt;RULE&#x27; //在指定的区删除一条富规则</span></div><div class="token-line"><span class="token plain">--query-rich-rule=&#x27;&lt;RULE&#x27;  //找到规则返回0 ，找不到返回1</span></div><div class="token-line"><span class="token plain">--list-rich-rules       //列出指定区里的所有富规则</span></div><div class="token-line"><span class="token plain">--list-all 和 --list-all-zones 也能列出存在的富规则</span></div><div class="token-line"><span class="token plain">
</span></div><div class="token-line"><span class="token plain">[rich-rule]有一套完整的 rich-rule-language:</span></div><div class="token-line"><span class="token plain">rule</span></div><div class="token-line"><span class="token plain">  [family=&quot;ipv4|ipv6&quot;]</span></div><div class="token-line"><span class="token plain">  [source address=&quot;address[/mask]&quot;|mac=&quot;mac-address&quot;|ipset=&quot;ipset&quot;]</span></div><div class="token-line"><span class="token plain">  [destination address=&quot;address[/mask]&quot;]</span></div><div class="token-line"><span class="token plain">  service|port|protocol|icmp-block|icmp-type|masquerade|forward-port|source-port</span></div><div class="token-line"><span class="token plain">  [log]</span></div><div class="token-line"><span class="token plain">  [audit]</span></div><div class="token-line"><span class="token plain">  [accept|reject|drop|mark]</span></div></pre></div><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --add-rich-rule=&quot;rule family=&quot;ipv4&quot; source address=&quot;192.168.2.1&quot; accept&quot; # accept表示接受，reject表示拒绝，drop表示直接丢弃，这条命令表示允许来自192.168.2.1的所有流量</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --add-rich-rule=&quot;rule family=&quot;ipv4&quot; source address=&quot;192.168.2.208&quot; service name=&quot;ssh&quot; accept&quot; # 允许192.168.2.208主机访问ssh服务</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --add-rich-rule=&quot;rule family=&quot;ipv4&quot; source address=&quot;192.168.2.1&quot; port protocol=&quot;tcp&quot; port=&quot;22&quot; accept&quot; # 允许192.168.2.1主机访问22端口</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=drop --add-rich-rule=&quot;rule family=&quot;ipv4&quot; source address=&quot;192.168.2.0/24&quot; port protocol=&quot;tcp&quot; port=&quot;22&quot; reject&quot; # 表示禁止192.168.2.0/24网段的主机访问22端口</span></div></pre></div><h5 id="应急命令"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#应急命令"><span class="icon icon-link"></span></a>应急命令</h5><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --panic-on  # 拒绝所有流量，远程连接会立即断开，只有本地能登陆</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --panic-off  # 取消应急模式，但需要重启firewalld后才可以远程ssh</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --query-panic  # 查看是否为应急模式</span></div></pre></div><h5 id="超时timeout"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#超时timeout"><span class="icon icon-link"></span></a>超时(timeout)</h5><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --zone=public --add-service=ssh --timeout=5m # 个timeout 选项是一个以秒（s）、分（m）或小时（h）为单位的时间值,表示该配置有效时间</span></div></pre></div><p>还有许多的规则配置就不一一列举了，需要时去查相关的命令即可。</p><p><strong>注意</strong>，以上配置都是运行时配置，如果需要使其永久生效在命令行后边加上<code>--permanent</code>选项然后重新加载，<strong>或者</strong>使用命令</p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --runtime-to-permanent</span></div></pre></div><p>也可以自定义自己的zone和service，见后文。</p><h5 id="创建自定义的zone"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#创建自定义的zone"><span class="icon icon-link"></span></a>创建自定义的zone</h5><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --new-zone=memcached --permanent # 创建zone</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=memcached --add-port=11211/udp --permanent # 添加规则</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=memcached --add-source=192.168.100.30/32 --permanent #同上</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --reload # 重新加载生效</span></div></pre></div><h4 id="服务设置"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#服务设置"><span class="icon icon-link"></span></a>服务设置</h4><h5 id="获取所有可用服务的列表"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#获取所有可用服务的列表"><span class="icon icon-link"></span></a>获取所有可用服务的列表</h5><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --get-services</span></div></pre></div><p>通过在<code>/usr/lib/firewalld/services</code>目录中打开相关的.xml文件，您可以找到关于每个服务的更多信息。例如，HTTP服务的定义如下:</p><div class="__dumi-default-code-block"><pre class="prism-code language-Xml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?</span></div><div class="token-line"><span class="token plain">&lt;service</span></div><div class="token-line"><span class="token plain">  &lt;shortWWW (HTTP)&lt;/short</span></div><div class="token-line"><span class="token plain">  &lt;descriptionHTTP is the protocol used to serve Web pages. If you plan to make your Web server publicly available, enable this option. This option is not required for viewing pages locally or developing Web pages.&lt;/description</span></div><div class="token-line"><span class="token plain">  &lt;port protocol=&quot;tcp&quot; port=&quot;80&quot;/</span></div><div class="token-line"><span class="token plain">&lt;/service&gt;</span></div></pre></div><p>为public区域中的接口允许传入HTTP通信流(端口80)，仅为当前会话(运行时配置)类型：</p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --zone=public --add-service=http</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --zone=public --list-services # 查看</span></div></pre></div><p>移除</p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --zone=public --remove-service=http</span></div></pre></div><h5 id="自定义服务"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#自定义服务"><span class="icon icon-link"></span></a>自定义服务</h5><p>如前所述，默认服务存储在<code>/usr/lib/firewalld/services</code>目录中。创建新服务的最简单方法是将现有的服务文件复制到<code>/etc/firewalld/services</code>目录，该目录是用户创建服务的位置，并修改文件设置。我们创建的<code>/etc/firewalld/services/plexmediaserver.xml</code>如下的</p><div class="__dumi-default-code-block"><pre class="prism-code language-Xml"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?</span></div><div class="token-line"><span class="token plain">&lt;service version=&quot;1.0&quot;</span></div><div class="token-line"><span class="token plain">&lt;shortplexmediaserver&lt;/short</span></div><div class="token-line"><span class="token plain">&lt;descriptionPlex is a streaming media server that brings all your video, music and photo collections together and stream them to your devices at anytime and from anywhere.&lt;/description</span></div><div class="token-line"><span class="token plain">&lt;port protocol=&quot;udp&quot; port=&quot;1900&quot;/</span></div><div class="token-line"><span class="token plain">&lt;port protocol=&quot;tcp&quot; port=&quot;32400&quot;/</span></div><div class="token-line"><span class="token plain">&lt;/service</span></div></pre></div><p>重新加载生效</p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --reload</span></div></pre></div><h2 id="实践"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#实践"><span class="icon icon-link"></span></a>实践</h2><p>其实到这里，我遇到的问题就可以迎刃而解了。</p><h3 id="1-放行整个区域"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#1-放行整个区域"><span class="icon icon-link"></span></a>1. 放行整个区域</h3><p>首先查看网卡接口和区域设置</p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ ip link show</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --get-active-zone</span></div><div class="token-line"><span class="token plain">public</span></div><div class="token-line"><span class="token plain">  interfaces: docker0 eth0</span></div></pre></div><p>根据<a target="_blank" rel="noopener noreferrer" href="https://kidon.fun/2020/03/10/firewalld/#jump">包处理流程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，由于没有源的分配，匹配到 interface 的 Zone，外网访问docker容器服务的时候会匹配到public区域，target是default，于是采用firewall默认行为。所以只要将default设置为ACCEPT便可访问。下面是我的操作,你也可以设置自己的策略。</p><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --set-default-zone=work # 设置默认区域为work</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --change-interface=docker0 # 将docker0接口分配到work区域</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --permanent --set-target=ACCEPT # 将target设置为ACCEPT</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --runtime-to-permanent # 设置永久生效</span></div></pre></div><h3 id="2-放行源地址"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#2-放行源地址"><span class="icon icon-link"></span></a>2. 放行源地址</h3><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --zone=home --add-source=192.168.1.1/24 --permanent</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --permanent --set-target=ACCEPT --zone=home</span></div><div class="token-line"><span class="token plain">$ firewall-cmd --reload</span></div></pre></div><h3 id="3-docker容器内dns问题"><a aria-hidden="true" tabindex="-1" href="/notes/linux/firewalld#3-docker容器内dns问题"><span class="icon icon-link"></span></a>3. docker容器内dns问题</h3><div class="__dumi-default-code-block"><pre class="prism-code language-Shell"><button class="__dumi-default-icon __dumi-default-code-block-copy-btn" data-status="ready"></button><div class="token-line"><span class="token plain">$ firewall-cmd --zone=public --add-masquerade --permanent &amp;&amp; firewall-cmd --reload</span></div></pre></div></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/zhuziyi1989/front-guidebook/edit/master/docs/notes/linux/firewalld.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last update: ">2022/3/1 17:06:41</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/umi.302945c4.js"></script>
  </body>
</html>
